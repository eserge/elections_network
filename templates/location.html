{% extends "base.html" %}

{% block title %}
{% if current_location.parent_1 %}{{ current_location.parent_1 }} - {% endif %}
{% if current_location.parent_2 %}{{ current_location.parent_2 }} - {% endif %}
{{ current_location }} - Гражданский контроль за выборами
{% endblock %}

{% block head %}
    <!--script type="text/javascript">
        VK.init({apiId: {{ VK_APP_ID }}, onlyWidgets: true});
    </script-->
{% endblock %}

{% block breadcrumbs %}
    <div class="ym-wrapper">
        <div class="breadcrumbs">
            <ul>
                <li class="first"><a href="{% url main %}">Россия<i></i><b></b></a></li>

                {% if current_location.parent_1 %}
                    <li>
                        <a href="{{ current_location.parent_1.get_absolute_url }}">{{ current_location.parent_1 }}<i></i><b></b></a> 
                    </li>
                {% endif %}
                {% if current_location.parent_2 %}
                    <li>
                        <a href="{{ current_location.parent_2.get_absolute_url }}">{{ current_location.parent_2 }}<i></i><b></b></a>
                    </li>
                {% endif %}

                <li>
                    <strong>{{ current_location }}<i></i><b></b></strong>
                </li>

                {% if sub_regions %}
                    <li>
                        <form id="goto_subregion_form" action="{% url goto_location %}" method="get" style="display:inline; margin:0; padding:0;">
                            <select id="goto_subregion" name="region_1">
                                <option value="" selected="selected">Перейти ниже</option>
                                {% for sub_region in sub_regions %}
                                <option value="{{ sub_region.id }}">{{ sub_region.name }}</option>
                                {% endfor %}
                            </select>
                            <!--<i></i><b></b>-->
                        </form>
                    </li>
                {% endif %}
            </ul>
        </div>
    </div>

    <script type="text/javascript">
        $("#goto_subregion").change(function(){
            $("#goto_subregion_form").submit();
        });
    </script>
{% endblock %}

{% block left_column %}
    <h3 class="column_header">Участники</h3>

    <div class="ym-clearfix">
        <div class="side_block_header">
            <h4>Наблюдатели</h4>
        </div>

        <div class="content_block">
            <ul class="side_list">
                {% for observer in roles.observer %}
                    <li><a href="{{ observer.get_absolute_url }}">{{ observer.username }}</a></li>
                {% endfor %}
            </ul>
            <center>
                <button id="become_observer">Записаться</button>
            </center>
        </div>

        <div class="side_block_header">
            <h4>Избиратели</h4>
        </div>

        <div class="content_block">
            <ul id="voters_ul" class="side_list">
                {% for voter in participants.voter %}
                    <li><a href="{{ voter.get_absolute_url }}">{{ voter.username }}</a></li>
                {% endfor %}
            </ul>
            <center>
                <button id="become_voter">
                    <span id="become_voter_sign_up_btn" {% if is_voter_here %}style="display:none"{% endif %}>
                        Записаться
                    </span>
                    <span id="become_voter_change_region_btn" {% if not is_voter_here %}style="display:none"{% endif %}>
                        Сменить округ
                    </span>
                </button>
            </center>
        </div>
    </div>

    {% include "dialogs/become_observer.html" %}

    {% include "dialogs/become_voter.html" %}

    {% include "dialogs/report.html" %}

    {% if user.is_authenticated %}
        {% include "dialogs/add_to_contacts.html" %}

        <script type="text/javascript">
            // Become voter
            $("#become_voter_dialog").on("become_voter_event", function(event, location_id){
                var user_voter_li = $('#voters_ul li a[href="{{ user.get_absolute_url }}"]').parent();
                if (location_id=={{ current_location.id }}){
                    $("#become_voter_sign_up_btn").hide();
                    $("#become_voter_change_region_btn").show();
                    if (user_voter_li.length==0)
                        $("#voters_ul").append($("<li/>").append(
                            $("<a/>").attr("href", "{{ user.get_absolute_url }}").text("{{ user.username }}")
                        ));
                } else {
                    $("#become_voter_sign_up_btn").show();
                    $("#become_voter_change_region_btn").hide();
                    user_voter_li.remove();
                }
            });
        </script>
    {% endif %}

    <script type="text/javascript">
        // TODO: move it inside become_voter.html
        $("#become_voter").button({icons: {
            primary: {% if is_voter_here %}"ui-icon-arrowreturnthick-1-e"{% else %}"ui-icon-check"{% endif %}
        }});

        $("#voters_ul li").each(function(index){
            new UserListItem($(this));
        });

        $("#add_to_contacts_dialog").on("add_to_contacts_event", function(event, username){
            // TODO: explicit use of url (use global variable instead) - everywhere
            $('#voters_ul li a[href="/users/'+username+'/"]').parent().children(".ui-icon-plus").css("visibility", "hidden");
        });

        $("#report_dialog").on("report_dialog_event", function(event, username){
            $('#voters_ul li a[href="/users/'+username+'/"]').parent().children(".ui-icon-notice").css("visibility", "hidden");
        });
    </script>
{% endblock %}

{% block right_column %}
    <h3 class="column_header">Инструменты</h3>

    <div class="ym-clearfix">
        <div class="side_block_header">
            <h4>Полезные ресурсы</h4>
        </div>

        <div class="content_block">
            <ul id="links_ul" class="side_list">
                {% for link in links %}
                <li><a href="{{ link.url }}" target="_blank">{{ link.name }}</a></li>
                {% endfor %}
            </ul>
            <center>
                <button id="add_link" title="Добавить ссылку">Добавить</button>
            </center>
        </div>

        <div class="side_block_header">
            <h4>Зафиксировать нарушение</h4>
        </div>

        <div class="content_block">
            <center>
                <button id="submit_complaint_btn" title="Зафиксировать нарушение">Зафиксировать</button>
            </center>
        </div>
    </div>

    <script type="text/javascript" src="//yandex.st/share/share.js" charset="utf-8"></script>
    <div class="yashare-auto-init" data-yashareL10n="ru" data-yashareType="none"
            data-yashareQuickServices="yaru,vkontakte,facebook,twitter,odnoklassniki,lj,moikrug"></div> 

    {% include "dialogs/add_link.html" %}

    {% include "dialogs/submit_complaint.html" %}

    {% if user.is_authenticated %}
        <script type="text/javascript">
            // Add link
            $("#add_link_dialog").on("add_link_event", function(){
                $("#links_ul").append($("<li/>").append(
                    $("<a/>").attr("target", "_blank").attr("href", $("#link_url_input").val())
                        .text($("#link_name_input").val())
                ));
            });

            /*$("#report_link").click(function(){
                // TODO: depricate it
                $("#links_ul li").each(function(index){
                    var url = $(this).children("a").attr("href");
                    var text = $(this).text();
                    var a_copy = $("<a/>").attr("href", url).text(text);
                    var radio_btn = $("<input/>").attr("type", "radio").attr("name", "report_link_radio").attr("value", url);
                    $("#report_link_ul").append($("<li/>").append(radio_btn).append(a_copy));
                });
            });*/
        </script>
    {% endif %}
{% endblock %}

{% block content_header %}
    <h2 class="location_header">{{ current_location }}</h2>

    <div>
        <div id="tabs">
            <ul>
                <li><a href="#tab-info">Информация<i></i></a></li>
                <li><a href="#tab-wall">Стена<i></i></a></li>
                <li><a href="#tab-map">Карта<i></i></a></li>
                <li><a href="#tab-help">Помощь<i></i></a></li>
            </ul>

            <div id="tab-info">
                <p>
                    Адрес ТИКа:
                </p>
            </div>

            <div id="tab-wall">
                <!--div id="vk_comments"></div>
                <script type="text/javascript">
                    VK.Widgets.Comments("vk_comments", {limit: 10, width: "496", attach: "*", autoPublish: 0});
                </script-->

                <a href="{{ request.path }}#disqus_thread" data-disqus-identifier="location/{{ current_location.id }}">First article</a>

                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    var disqus_shortname = "{{ DISQUS_SHORTNAME }}";
                    var disqus_identifier = "location/{{ current_location.id }}";
                    var disqus_developer = 1;

                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Пожалуйста, активируйте JavaScript, чтобы просматривать <a href="http://disqus.com/?ref_noscript">комментарии</a>.</noscript>
            </div>

            <div id="tab-map">
                <p>3</p>
            </div>

            <div id="tab-help">
                <p>
                    Здесь будет выложен небольшой текст с со стрелками, объясняющий как пользоваться страницей
                    избирательного округа:
                    <ul>
                        <li>
                            <b>слева</b>: список пользователей площадки, зарегистрированных на странице текущего
                            избирательного округа. Участники разбиты на группы согласно тому,
                            какую роль в выборном процессе они играют. По нажатию на имя/ник пользователя открывается
                            его личная страница. На ней у залогиненных пользователей будет возможность писать
                            участникам сообщения, добавлять в контакты и жаловаться на них.
                        </li>
                        <li>
                            <b>справа</b>: список инструментов для участников площадки. С их помощью можно
                            эффективно контролировать проведение выборов на избирательном округе выбранной страницы.
                        </li>
                        <li>
                            <b>сверху</b>:
                            <ul>
                                <li>
                                    <b>меню</b>: подробная информация о проекте, способы помочь проекту, карта для нахождения
                                    страницы избирательного округа по адресу
                                </li>
                                <li>
                                    <b>путь</b>: легкий способ ориентироваться в иерархии страниц избирательных округов
                                    <b>вкладки</b>: различная информация об избирательном участке
                                </li>
                            </ul>
                        </li>
                        <li>
                            <b>внизу</b>: кнопки соцсетей
                        </li>
                        <li>
                            <b>на границе экрана слева</b>: кнопка для оставления комментариев и отзывов о работе площадки,
                            сообщение о найденных багах сайта
                        </li>
                    </ul>
                </p>
            </div>
        </div>
    </div>

    <script>
        $("#tabs").tabs();
    </script>

    <script type="text/javascript">
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>

{% endblock %}
